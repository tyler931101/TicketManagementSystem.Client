<Page x:Class="TicketManagementSystem.Client.Views.AdminDashboardPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:vm="clr-namespace:TicketManagementSystem.Client.ViewModels"
      xmlns:converters="clr-namespace:TicketManagementSystem.Client.Converters"
      Title="AdminDashboard">

    <Page.Resources>
        <converters:EqualityConverter x:Key="EqualityConverter"/>
        <converters:StringToInitialsConverter x:Key="StringToInitialsConverter"/>
        <converters:RoleToColorConverter x:Key="RoleToColorConverter"/>
        <converters:RoleToBorderColorConverter x:Key="RoleToBorderColorConverter"/>
        <converters:RoleToTextColorConverter x:Key="RoleToTextColorConverter"/>
        <converters:BooleanToStatusColorConverter x:Key="BooleanToStatusColorConverter"/>
        <converters:BooleanToStatusTextConverter x:Key="BooleanToStatusTextConverter"/>
        <converters:IndexToDisplayNumberConverter x:Key="IndexToDisplayNumberConverter"/>
    </Page.Resources>

    <Grid Background="{StaticResource BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="150"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Style="{StaticResource GlobalHeaderStyle}" BorderBrush="#E0E0E0" BorderThickness="1">
            <StackPanel>
                <!-- Title Row -->
                <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                    <Image Source="../Resources/PageLinkIcons/user.png"
                            Style="{StaticResource GlobalHeaderIconStyle}"/>
                    <TextBlock Text="User Management" Style="{StaticResource GlobalHeaderTitleStyle}"/>
                </StackPanel>

                <!-- Filter Controls Row -->
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Search -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal">
                        <TextBlock Text="Search:" Style="{StaticResource GlobalHeaderLabelStyle}" Width="60"/>
                        <TextBox x:Name="SearchBox" Style="{StaticResource GlobalHeaderTextBoxStyle}"
                                Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" 
                                Tag="Search users..."/>

                        <Button Content="Reset Filters" Command="{Binding ClearFiltersCommand}"
                                Style="{StaticResource GlobalHeaderButtonStyle}"
                                Width="100" Height="30" Margin="10,0,0,0"/>
                    </StackPanel>
                </Grid>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <ScrollViewer.Resources>
                <Style TargetType="ScrollBar" BasedOn="{StaticResource ModernScrollBarStyle}"/>
            </ScrollViewer.Resources>

            <Border Background="{StaticResource CardBrush}" Padding="15,12,15,12" Margin="10" BorderBrush="#E0E0E0" 
                            Effect="{StaticResource DropShadowEffect}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Users DataGrid -->
                    <Border Grid.Row="1" Background="White" BorderBrush="#E0E0E0" BorderThickness="1">
                        <DataGrid x:Name="UsersDataGrid"
                              ItemsSource="{Binding FilteredUsers}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              CanUserReorderColumns="False"
                              CanUserResizeColumns="True"
                              CanUserResizeRows="False"
                              CanUserSortColumns="True"
                              GridLinesVisibility="None"
                              AlternationCount="1000000"
                              VerticalGridLinesBrush="Transparent"
                              Background="White"
                              BorderThickness="0"
                              HeadersVisibility="Column"
                              RowHeight="50"
                              Padding="0">
                        <DataGrid.ColumnHeaderStyle>
                            <Style TargetType="DataGridColumnHeader">
                                <Setter Property="Background" Value="#F8F9FA"/>
                                <Setter Property="Foreground" Value="#495057"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                                <Setter Property="FontSize" Value="13"/>
                                <Setter Property="Padding" Value="15,12"/>
                                <Setter Property="BorderBrush" Value="#E0E0E0"/>
                                <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                <Setter Property="HorizontalAlignment" Value="Stretch"/>
                                <Setter Property="HorizontalContentAlignment" Value="Left"/>
                            </Style>
                        </DataGrid.ColumnHeaderStyle>
                        <DataGrid.RowStyle>
                            <Style TargetType="DataGridRow">
                                <Setter Property="Background" Value="White"/>
                                <Setter Property="BorderThickness" Value="0"/>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="#F5F9FF"/>
                                    </Trigger>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="#E3F2FD"/>
                                        <Setter Property="Foreground" Value="Black"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.RowStyle>
                        <DataGrid.CellStyle>
                            <Style TargetType="DataGridCell">
                                <Setter Property="BorderThickness" Value="0"/>
                                <Setter Property="Padding" Value="15,0"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="DataGridCell">
                                            <Border Padding="{TemplateBinding Padding}" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}">
                                                <ContentPresenter VerticalAlignment="Center"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="Foreground" Value="Black"/>
                                        <Setter Property="BorderThickness" Value="0"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.CellStyle>
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="No" Binding="{Binding RowNumber}" Width="60" Foreground="#9E9E9E"/>
                            <DataGridTemplateColumn Header="Username" Width="1.5*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Border Width="32" Height="32" CornerRadius="16" Background="#E3F2FD" Margin="0,0,10,0">
                                                <TextBlock Text="{Binding Username, Converter={StaticResource StringToInitialsConverter}}" 
                                                           HorizontalAlignment="Center" VerticalAlignment="Center" 
                                                           Foreground="#1976D2" FontWeight="Bold" FontSize="12"/>
                                            </Border>
                                            <TextBlock Text="{Binding Username}" FontWeight="SemiBold" Foreground="#212529" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTextColumn Header="Email" Binding="{Binding Email}" Width="2*" Foreground="#6C757D"/>
                            
                            <DataGridTextColumn Header="Phone" Binding="{Binding PhoneNumber}" Width="150" Foreground="#6C757D"/>
                            
                            <DataGridTextColumn Header="Address" Binding="{Binding Address}" Width="2*" Foreground="#6C757D"/>

                            <DataGridTemplateColumn Header="Role" Width="120">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border CornerRadius="4" Padding="8,4" HorizontalAlignment="Left"
                                                Background="{Binding Role, Converter={StaticResource RoleToColorConverter}}"
                                                BorderBrush="{Binding Role, Converter={StaticResource RoleToBorderColorConverter}}"
                                                BorderThickness="1">
                                            <TextBlock Text="{Binding Role}" FontSize="12" FontWeight="SemiBold"
                                                       Foreground="{Binding Role, Converter={StaticResource RoleToTextColorConverter}}"/>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="Status" Width="120">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Border Width="8" Height="8" CornerRadius="4" Margin="0,0,8,0"
                                                    Background="{Binding IsLoginAllowed, Converter={StaticResource BooleanToStatusColorConverter}}"/>
                                            <TextBlock Text="{Binding IsLoginAllowed, Converter={StaticResource BooleanToStatusTextConverter}}"
                                                       Foreground="{Binding IsLoginAllowed, Converter={StaticResource BooleanToStatusColorConverter}}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            
                            <DataGridTextColumn Header="Joined" Binding="{Binding CreatedAt, StringFormat='{}{0:MMM dd, yyyy}'}" Width="150" Foreground="#6C757D"/>
                            
                            <DataGridTemplateColumn Header="Action" Width="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Button Content="âœï¸" FontSize="14" Background="Transparent" BorderThickness="0" Padding="4" 
                                                    Cursor="Hand" ToolTip="Edit User" Margin="0,0,5,0">
                                                <Button.Template>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border Background="{TemplateBinding Background}" CornerRadius="4">
                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                        </Border>
                                                    </ControlTemplate>
                                                </Button.Template>
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="#E3F2FD"/>
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                            <Button Content="ðŸ—‘ï¸" FontSize="14" Background="Transparent" BorderThickness="0" Padding="4" 
                                                    Cursor="Hand" ToolTip="Delete User">
                                                <Button.Template>
                                                    <ControlTemplate TargetType="Button">
                                                        <Border Background="{TemplateBinding Background}" CornerRadius="4">
                                                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                        </Border>
                                                    </ControlTemplate>
                                                </Button.Template>
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="#FFEBEE"/>
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Border>
                
                <!-- Pagination Controls -->
                <Grid Grid.Row="2" Margin="0,20,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Page Info -->
                    <TextBlock Grid.Column="0" VerticalAlignment="Center" Foreground="#6C757D">
                        <Run Text="Showing"/>
                        <Run Text="{Binding StartRecord}" FontWeight="SemiBold" Foreground="#212529"/>
                        <Run Text="-"/>
                        <Run Text="{Binding EndRecord}" FontWeight="SemiBold" Foreground="#212529"/>
                        <Run Text="of"/>
                        <Run Text="{Binding TotalRecords}" FontWeight="SemiBold" Foreground="#212529"/>
                    </TextBlock>
                    
                    <!-- Pagination Buttons -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal">
                        <TextBlock Text="Rows:" VerticalAlignment="Center" Margin="0,0,10,0" Foreground="#6C757D"/>
                        <ComboBox x:Name="PageSizeComboBox" Width="80" Margin="0,0,15,0"
                                  Style="{StaticResource GlobalHeaderComboBoxStyle}"
                                  SelectedValue="{Binding PageSize, Mode=TwoWay}" SelectedValuePath="Tag">
                            <ComboBoxItem Tag="5" Content="5"/>
                            <ComboBoxItem Tag="10" Content="10"/>
                            <ComboBoxItem Tag="20" Content="20"/>
                            <ComboBoxItem Tag="50" Content="50"/>
                        </ComboBox>
                        <Button Command="{Binding PreviousPageCommand}" Margin="0,0,5,0"
                                Style="{StaticResource PaginationButtonStyle}" Content="Previous"/>
                        
                        <ItemsControl ItemsSource="{Binding PageNumbers}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Button Content="{Binding}" 
                                            Command="{Binding DataContext.GoToPageCommand, RelativeSource={RelativeSource AncestorType=Page}}" 
                                            CommandParameter="{Binding}"
                                            Margin="2,0" Width="32" Height="32">
                                        <Button.Style>
                                            <Style TargetType="Button" BasedOn="{StaticResource PaginationPageButtonStyle}">
                                                <Style.Triggers>
                                                    <DataTrigger Value="True">
                                                        <DataTrigger.Binding>
                                                            <MultiBinding Converter="{StaticResource EqualityConverter}">
                                                                <Binding Path="."/>
                                                                <Binding Path="DataContext.CurrentPage" RelativeSource="{RelativeSource AncestorType=Page}"/>
                                                            </MultiBinding>
                                                        </DataTrigger.Binding>
                                                        <Setter Property="Background" Value="#1976D2"/>
                                                        <Setter Property="Foreground" Value="White"/>
                                                        <Setter Property="BorderBrush" Value="#1976D2"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        
                        <TextBlock Text="..." VerticalAlignment="Center" Margin="5,0" Foreground="#6C757D"
                                   Visibility="{Binding ShowEllipsis, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                        
                        <Button Content="{Binding LastPageNumber}" 
                                Command="{Binding GoToLastPageCommand}"
                                Margin="2,0" Width="32" Height="32"
                                Visibility="{Binding ShowLastPageButton, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource PaginationPageButtonStyle}">
                                    <Style.Triggers>
                                        <DataTrigger Value="True">
                                            <DataTrigger.Binding>
                                                <MultiBinding Converter="{StaticResource EqualityConverter}">
                                                    <Binding Path="LastPageNumber"/>
                                                    <Binding Path="CurrentPage"/>
                                                </MultiBinding>
                                            </DataTrigger.Binding>
                                            <Setter Property="Background" Value="#1976D2"/>
                                            <Setter Property="Foreground" Value="White"/>
                                            <Setter Property="BorderBrush" Value="#1976D2"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        
                        <Button Command="{Binding NextPageCommand}" Margin="5,0,0,0"
                                Style="{StaticResource PaginationButtonStyle}" Content="Next"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>
    </ScrollViewer>
</Grid>
</Page>
